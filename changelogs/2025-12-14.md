# Changelog - December 14, 2025

## Summary

Major improvements to test coverage, bug fixes for Unit profile resolution, React frontend implementation, and Render deployment configuration.

## Testing Improvements

### Handler Tests
- Added comprehensive handler test coverage:
  - `TestGetCatalogueUnitsHandler` - Tests catalogue units endpoint
  - `TestGetFactionUnitsHandler` - Tests faction units endpoint
  - `TestGetUnitHandlerNotFound` - Error handling for non-existent units
  - `TestGetCatalogueHandlerNotFound` - Error handling for non-existent catalogues
  - `TestGetCatalogueUnitsHandlerNotFound` - Error handling for non-existent catalogue units
  - `TestGetUnitWeaponsHandlerNotFound` - Error handling for non-existent unit weapons
  - `TestListUnitsHandlerPagination` - Pagination functionality
  - `TestListUnitsHandlerFilters` - Search and faction filtering
  - `TestSearchHandlerWithLimit` - Search with limit parameter

**Result**: All 17 handler tests passing

### Service Verification Tests
- Created `TestAllNecronUnits` - Comprehensive verification test for all 62 Necron units
  - Validates unit profiles, abilities, weapons, costs, categories, and rules
  - All 62 Necron units verified successfully (100% pass rate)

## Bug Fixes

### Unit Profile Resolution via InfoLinks
**Issue**: "Grot Tanks [Legends]" unit was failing verification because its Unit profile was referenced via an `infoLink` with `type="profile"` pointing to `sharedProfiles`, but the transformer wasn't handling this pattern.

**Solution**:
1. Added `SharedProfiles []Profile` field to `Catalogue` model (`api/internal/models/catalogue.go`)
2. Added `GetProfile()` method to `Parser` (`api/internal/parser/parser.go`) to look up profiles from sharedProfiles
3. Enhanced `Transformer` to check infoLinks for Unit profiles:
   - Added `findUnitProfileInInfoLinks()` - Recursively searches infoLinks for Unit profiles
   - Added `findUnitProfileInInfoLinksInGroup()` - Searches infoLinks in selectionEntryGroups
   - Integrated into `transformProfiles()` as fallback after other profile checks

**Files Modified**:
- `api/internal/models/catalogue.go`
- `api/internal/parser/parser.go`
- `api/internal/parser/transformer.go`

**Result**: All Ork units (including Grot Tanks [Legends]) now pass verification (88/88 units)

## Frontend Implementation

### React Application Structure
Created a complete React + TypeScript frontend application:

**Technology Stack**:
- React 18.3.1
- TypeScript 5.5.4
- Vite 5.4.3 (build tool)
- React Router 6.26.0 (routing)
- Axios 1.7.7 (HTTP client)

**Project Structure**:
```
web/
├── src/
│   ├── components/     # Layout component with navigation
│   ├── pages/          # Home, Units, UnitDetail, Catalogues, Factions, Search
│   ├── utils/          # API client with TypeScript types
│   ├── App.tsx         # Main app with routing
│   └── main.tsx        # Entry point
├── public/
├── package.json
├── vite.config.ts      # Vite config with API proxy for dev
└── tsconfig.json
```

**Features Implemented**:
- Unit browsing with search and faction filters
- Unit detail pages showing profiles, abilities, weapons, and costs
- Catalogue listing
- Faction listing and faction unit browsing
- Search functionality
- Responsive design with dark theme
- Full TypeScript type safety

**Files Created**: 20+ new files in `web/` directory

## Deployment Configuration

### Render Deployment Setup
Configured monorepo for deployment on Render with two services:

**Backend API Service** (`grimoire-api`):
- Environment: Go
- Root directory: `api`
- Build command: `git submodule update --init --recursive && go build -o server ./cmd/server`
- Start command: `./server`
- Environment variables: `PORT`, `DATA_DIR`, `GIN_MODE`
- Health check: `/health`

**Frontend Service** (`grimoire-web`):
- Environment: Static
- Root directory: `web`
- Build command: `npm install && npm run build`
- Static publish path: `./dist`
- Environment variable: `VITE_API_URL`

**Files Created/Modified**:
- `render.yaml` - Render Blueprint configuration
- `.renderignore` - Excludes test files, build artifacts, and unnecessary files
- `api/Dockerfile` - Fixed to correctly copy data files from repository root

## Development Tools

### Startup Scripts
Created convenient development scripts:

**`start.sh`**:
- Installs all dependencies (Go + npm)
- Initializes git submodule if needed
- Starts both API and web in same terminal (background processes)
- Handles cleanup on Ctrl+C

**`start-dev.sh`**:
- Same as `start.sh` but opens separate terminal windows
- Better for development (see logs separately)
- macOS/Linux compatible

**`Makefile`**:
- `make install` - Install all dependencies
- `make start` - Start both services (same terminal)
- `make dev` - Start both services (separate terminals)
- `make start-api` - Start only API
- `make start-web` - Start only web
- `make test` - Run all tests
- `make clean` - Clean build artifacts
- `make update-submodule` - Update wh40k-10e submodule

## Documentation

### New Documentation Files
- `README.md` - Project overview and quick start guide
- `SUBMODULE_MAINTENANCE.md` - Guide for maintaining the git submodule
- `api/internal/service/necrons_verification_test.go` - Necron units verification test
- `web/README.md` - Frontend documentation

## Git Submodule Configuration

- Confirmed `wh40k-10e/` is properly configured as git submodule
- Updated Render build commands to initialize submodules
- Created maintenance guide for submodule updates

## Test Results

- **Handler Tests**: 17/17 passing
- **Service Tests**: All passing
- **Ork Units Verification**: 88/88 units passing (100%)
- **Necron Units Verification**: 62/62 units passing (100%)

## Files Changed Summary

### New Files
- `render.yaml`
- `.renderignore`
- `start.sh`
- `start-dev.sh`
- `Makefile`
- `README.md`
- `SUBMODULE_MAINTENANCE.md`
- `web/` directory (20+ files)
- `api/internal/service/necrons_verification_test.go`

### Modified Files
- `api/internal/models/catalogue.go` - Added SharedProfiles field
- `api/internal/parser/parser.go` - Added GetProfile method
- `api/internal/parser/transformer.go` - Added infoLink profile resolution
- `api/internal/handlers/handlers_test.go` - Added 9 new test functions
- `api/Dockerfile` - Fixed data file copying

## Next Steps

1. Deploy to Render using `render.yaml`
2. Update `VITE_API_URL` in `render.yaml` with actual API URL after deployment
3. Continue frontend development and styling
4. Consider adding more verification tests for other factions

